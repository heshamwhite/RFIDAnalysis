<div class="container-fluid">

    <div class="row">
        <h1 class="page-header text-center"><span class="fa fa-arrows-v"></span> User Arrivals and Departures</h1>
    </div>

    <div id="main_content" class="row">

        <div id="controls_view" class="col-sm-3">
			<div class="panel panel-primary">

				<div class="panel-heading">
				    <h3 class="panel-title">Query Builder</h3>
				</div>

				<div class="panel-body">
				    <form>
				        <div class="form-group">
				            <label for="">Select User</label>
				            <select id="user_list" class="form-control"></select>
				        </div>

				        <div class="pull-right">
				            <div class="btn-group-lg" role="group" aria-label="...">
				                <button id="table_button" type="button" class="btn btn-warning">
				                    <span class="fa fa-table"></span>
				                </button>
				                <button id="graph_button" type="button" class="btn btn-success">
				                    <span class="fa fa-bar-chart-o"></span>
				                </button>
				            </div>
				        </div>

				    </form>
				</div>

			</div>
        </div>

        <div class="col-sm-9">

            <div id="table_view" style="display: none">
				<table class="table table-striped">
				    <tr>
				        <th class="text-center">User Identity</th>
				        <th class="text-center">Number of Arrivals</th>
				        <th class="text-center">Number of Departures</th>
				    </tr>
				</table>
            </div>

            <div id="data_view"></div>

        </div>

    </div>

</div>

<script type="text/javascript" charset="utf-8">

	var categories = [];
	var series = [];

	$(document).ready(function()
    {

	    $("#table_button").click(function(){
		    $('#data_view').hide();
		    $('#table_view').show();
	    });

	    $("#graph_button").click(function(){
		    $('#table_view').hide();
		    $('#data_view').show();
	    });

		var userList = $("#user_list");

		var arrivalObject = {
			name: 'Arrivals',
			data: []
		};
		var departureObject = {
			name: 'Departures',
			data: []
		};

		$.ajax({
			url: 'user_traffics/list',
			method: 'GET',
			success: function(data)
			{
				// Add the all users option to the user list.
				userList.append("<option value='All Users'>All Users</option>");

				// Add the data received in the arrays for the graph.
				for (var i in data)
				{
					// Add name in the categories for the X-Axis.
					categories.push(data[i].name);

					// Add the user names as option in the select input.
					userList.append("<option value='"+data[i].name+"'>"+data[i].name+"</option>");

					arrivalObject.data.push(data[i].arrival_traffic);
					departureObject.data.push(data[i].departure_traffic);
				}

				// Add the data of the series to their corresponding objects
				series.push(arrivalObject);
				series.push(departureObject);

				// Get all the users and print the graph.
				drawUserTrafficGraph(categories,series);

				// Attach listener to the user list.
				userList.change(function()
                {
					var value = userList.val();

					if(value == 'All Users')
						drawUserTrafficGraph(categories,series);
					else
					{
						for(var i in data)
						{
							if(data[i].name == value)
							{
								var cat = [value];
								var ser = [
									{
										name: 'Arrival',
										data: [data[i].arrival_traffic]
									},
									{
										name: 'Departure',
										data: [data[i].departure_traffic]
									}
								];

								// Draw the Graph using the names and the data.
								drawUserTrafficGraph(cat,ser);
							}
						}
					}
				});
			}
		});
    });

	function drawUserTrafficGraph(categories, series)
	{
		$('#data_view').highcharts({

			// Chart options.
			chart:
			{
				type: 'column'
			},

			// Chart Title.
			title:
			{
				text: 'Employees Total Traffic'
			},

			// X-axis options.
			xAxis:
			{
				min: 0,
				max: 10,
				// Enter the user names here.
				categories: categories
			},

			scrollbar: {
				enabled: true
			},

			// Y-Axis options.
			yAxis:
			{
				min: 0,
				title:
				{
					text: 'Number of Arrivals/Departures'
				},
				stackLabels:
				{
					enabled: true,
					style:
					{
						fontWeight: 'bold',
						color: (Highcharts.theme && Highcharts.theme.textColor) || 'gray'
					}
				}
			},

			legend:
			{
				align: 'right',
				x: -30,
				verticalAlign: 'top',
				y: 25,
				floating: true,
				backgroundColor: (Highcharts.theme && Highcharts.theme.background2) || 'white',
				borderColor: '#CCC',
				borderWidth: 1,
				shadow: false
			},

			tooltip:
			{
				formatter: function ()
				{
					return '<b>' + this.x + '</b><br/>' +
					       this.series.name + ': ' + this.y + '<br/>' +
					       'Total: ' + this.point.stackTotal;
				}
			},

			plotOptions:
			{
				column: {
					stacking: 'normal',
					dataLabels: {
						enabled: true,
						color: (Highcharts.theme && Highcharts.theme.dataLabelsColor) || 'white',
						style: {
							textShadow: '0 0 3px black'
						}
					}
				}
			},

			series: series
		});
	}

</script>